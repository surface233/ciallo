<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸›é›¨Â·æ‘¸å¤´å¥½æ„Ÿåº¦æ¸¸æˆ</title>
    <link rel="icon" href="./image/murasame2.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="./image/murasame2.jpg">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(145deg, #2b1a1a 0%, #1f2b3a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        .game-container {
            max-width: 650px;
            width: 100%;
            background: rgba(30, 20, 30, 0.85);
            backdrop-filter: blur(8px);
            border-radius: 36px;
            padding: 30px 25px;
            box-shadow: 0 30px 40px rgba(0,0,0,0.6);
            border: 1px solid #a67c7c40;
            color: #f0e6d2;
        }
        /* å¥½æ„Ÿåº¦æ¡ + é‡ç½®æŒ‰é’®è¡Œ */
        .affection-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .affection-wrapper {
            flex: 1;
        }
        .affection-text {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #ffcfcf;
            font-weight: 500;
        }
        .affection-bar {
            background: #3a2a2a;
            height: 24px;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px #1a0f0f;
            border: 1px solid #7a4f4f;
        }
        .affection-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #f9a8a8, #ff6b6b, #d94141);
            border-radius: 30px;
            transition: width 0.2s ease;
            box-shadow: 0 0 10px #ff7b7b;
        }
        .reset-btn {
            background: #4d2f2f;
            border: 2px solid #b36b6b;
            color: #ffe3e3;
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 3px 0 #2d1b1b;
            transition: 0.2s;
        }
        .reset-btn:hover {
            background: #6f4040;
            border-color: #ff9494;
            transform: translateY(-2px);
            box-shadow: 0 5px 0 #2d1b1b;
        }
        .reset-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #2d1b1b;
        }
        /* å›¾ç‰‡åŒºåŸŸ */
        .image-area {
            text-align: center;
            margin: 20px 0;
        }
        .image-area img {
            max-width: 100%;
            border-radius: 24px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 2px solid #a14f4f;
            background: #2d1e1e;
        }
        .caption {
            margin-top: 8px;
            color: #d9b3b3;
            font-style: italic;
            font-size: 0.95rem;
        }
        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 25px 0 15px;
        }
        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .game-btn {
            background: #4d2f2f;
            border: 2px solid #b36b6b;
            color: #ffe3e3;
            padding: 12px 18px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            flex: 1 1 auto;
            min-width: 160px;
            box-shadow: 0 5px 0 #2d1b1b;
        }
        .game-btn:hover {
            background: #6f4040;
            border-color: #ff9494;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #2d1b1b;
        }
        .game-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #2d1b1b;
        }
        /* å¤§å¤§çš„cialloæ˜¾ç¤ºåŒº */
        .ciallo-message {
            font-size: 4rem;
            font-weight: 900;
            text-align: center;
            color: #ffb7c5;
            text-shadow: 0 0 20px #ff69b4, 0 0 40px #b43b6f;
            letter-spacing: 6px;
            margin: 10px 0 0;
            line-height: 1.2;
            word-break: break-word;
            background: rgba(0,0,0,0.3);
            border-radius: 60px;
            padding: 15px 5px;
            border: 2px dashed #ff9ecb;
            display: none;
        }
        .ciallo-message.show {
            display: block;
        }
        /* é¡µè„š */
        .footer {
            margin-top: 35px;
            text-align: center;
            font-size: 0.85rem;
            color: #b28b8b;
            border-top: 1px solid #7f4f4f40;
            padding-top: 18px;
        }
        .footer a {
            color: #f5adad;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameApp">
        <!-- å¥½æ„Ÿåº¦æ¡ + é‡ç½®æŒ‰é’® -->
        <div class="affection-row">
            <div class="affection-wrapper">
                <div class="affection-text">å¥½æ„Ÿåº¦: <span id="affectionValue">50</span> / 100</div>
                <div class="affection-bar">
                    <div class="affection-fill" id="affectionFill" style="width: 50%;"></div>
                </div>
            </div>
            <button class="reset-btn" id="resetGameBtn">ğŸ”„ é‡ç½®æ¸¸æˆ</button>
        </div>

        <!-- å¤§å¤§çš„cialloæ˜¾ç¤ºåŒºï¼ˆç‚¹å‡»å½©è›‹æŒ‰é’®åå‡ºç°ï¼‰ -->
        <div id="cialloDisplay" class="ciallo-message">ciallo</div>

        <!-- å›¾ç‰‡ä¸captionåŠ¨æ€åŒºåŸŸ -->
        <div class="image-area" id="imageArea">
            <img id="sceneImage" src="./image/ciallo.jpg" alt="scene">
            <div id="imageCaption" class="caption">é›‘é­šæŸšå­å¨~ğŸ’—ğŸ’—ğŸ’—</div>
        </div>

        <!-- æŒ‰é’®ç»„ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
        <div id="buttonPanel" class="button-group"></div>

        <!-- é¡µè„šï¼ˆå®Œæ•´ç‰ˆï¼‰ -->
        <div class="footer">
            âš¡ é¡¹ç›®åŸä½œè€…ï¼šGuderisans/Murasame Â· æ”¹ç¼–ï¼š
            <a href="https://space.bilibili.com/178329117" target="_blank">bilibiliæµ®å…‰æ å½±awsl</a><br>
            âš¡ ä»“åº“åœ°å€ï¼š
            <a href="https://github.com/surface233/ciallo" target="_blank">surface233/ciallo</a><br>
            âš¡ ä¸ªäººç½‘ç«™ï¼š
            <a href="https://surface233.top" target="_blank">surface233.top</a><br>
            <span style="opacity:0.7;">â€”â€” ä¸›é›¨æ‘¸å¤´æ¨¡æ‹Ÿå™¨ Â· çº¯çˆ±ç‰ˆ â€”â€”</span>
        </div>
    </div>

    <script>
        (function() {
            // ---------- å…¨å±€çŠ¶æ€ ----------
            let state = {
                current_step: 0,
                current_step1: 1,
                affection: 50,
                fail: 1,
                volume: 0.5
            };

            const audioMap = new Map();
            let playingAudios = [];

            function getAudioElement(src, customVolume = null) {
                if (!audioMap.has(src)) {
                    const audio = new Audio(src);
                    audio.preload = 'auto';
                    audio.loop = false;
                    audio.volume = customVolume !== null ? customVolume : state.volume;
                    audioMap.set(src, audio);
                }
                return audioMap.get(src);
            }

            function play_audio(src, custom_volume = null) {
                const audio = getAudioElement(src, custom_volume);
                audio.pause();
                audio.currentTime = 0;
                audio.play().catch(e => console.log('æ’­æ”¾å¤±è´¥:', src, e));
                if (!playingAudios.includes(src)) {
                    playingAudios.push(src);
                }
            }

            function stop_audio(src) {
                if (audioMap.has(src)) {
                    const audio = audioMap.get(src);
                    audio.pause();
                    audio.currentTime = 0;
                }
                playingAudios = playingAudios.filter(s => s !== src);
            }

            function pause_all_audio() {
                playingAudios.forEach(src => {
                    if (audioMap.has(src)) {
                        audioMap.get(src).pause();
                    }
                });
                playingAudios = [];
            }

            function updateAffectionUI() {
                document.getElementById('affectionValue').innerText = state.affection;
                const percent = Math.min(100, Math.max(0, state.affection)) + '%';
                document.getElementById('affectionFill').style.width = percent;
            }

            function showBigCiallo() {
                const cialloDiv = document.getElementById('cialloDisplay');
                cialloDiv.classList.add('show');
                setTimeout(() => {
                    cialloDiv.classList.remove('show');
                }, 2000);
            }

            // ===== æ–°å¢ï¼šé‡ç½®æ¸¸æˆå‡½æ•° =====
            function resetGame() {
                pause_all_audio();
                state.affection = 50;
                state.current_step = 1;
                state.fail = 1;
                render();
            }

            function render() {
                const imgEl = document.getElementById('sceneImage');
                const captionEl = document.getElementById('imageCaption');
                const buttonPanel = document.getElementById('buttonPanel');
                buttonPanel.innerHTML = '';

                updateAffectionUI();

                if (state.affection >= 100) {
                    pause_all_audio();
                    imgEl.src = './image/murasame8.jpg';
                    captionEl.innerText = 'å˜¿å˜¿~ ç‹—ä¿®é‡‘ğŸ’—';
                    play_audio('./audio/Murasame5.mp3');
                    play_audio('./audio/song1.mp3');
                    buttonPanel.innerHTML = `
                        <div class="button-row">
                            <button class="game-btn" id="winNextBtn">666è¿˜æœ‰ç¬¬äºŒå…³</button>
                            <button class="game-btn" id="winExitBtn">é€€å‡ºæ¸¸æˆ</button>
                        </div>
                    `;
                    document.getElementById('winNextBtn')?.addEventListener('click', () => {
                        state.current_step = 1;
                        state.fail = 2;
                        state.affection = 50;
                        render();
                    });
                    document.getElementById('winExitBtn')?.addEventListener('click', () => {
                        showBigCiallo();
                        state.current_step = 114514;
                        state.affection = 78;
                        render();
                    });
                }
                else if (state.affection <= 0 || state.current_step === -1) {
                    pause_all_audio();
                    play_audio('./audio/Murasame4.mp3');
                    play_audio('./audio/man.mp3');
                    imgEl.src = './image/murasame4.webp';
                    captionEl.innerText = 'è±ªèµ¤ğŸ˜‹ï¼ï¼ï¼';
                    buttonPanel.innerHTML = `
                        <div class="button-row">
                            <button class="game-btn" id="resetBtn">ç¬¬ä¸‰ç‚¸å¼¹ï¼Œè´¥è€…é£Ÿå°˜ï¼</button>
                            <button class="game-btn" id="gameExitBtn">é€€å‡ºæ¸¸æˆ</button>
                        </div>
                    `;
                    document.getElementById('resetBtn')?.addEventListener('click', () => {
                        stop_audio('./audio/Murasame4.mp3');
                        stop_audio('./audio/man.mp3');
                        play_audio('./audio/song.mp3', 0.1);
                        state.affection = 50;
                        state.current_step = 1;
                        state.fail = 2;
                        render();
                    });
                    document.getElementById('gameExitBtn')?.addEventListener('click', () => {
                        pause_all_audio();
                        showBigCiallo();
                        state.current_step = 114514;
                        state.affection = 78;
                        render();
                    });
                }
                else if (state.current_step === 114514) {
                    stop_audio('./audio/Murasame4.mp3');
                    stop_audio('./audio/man.mp3');
                    pause_all_audio();
                    imgEl.src = './image/ciallo.jpg';
                    captionEl.innerText = 'ä½  è¢« éª— äº† ! ! !';
                    buttonPanel.innerHTML = `
                        <div class="button-row">
                            <button class="game-btn" id="backBtn">æˆ˜è´¥BGM</button>
                        </div>
                    `;
                    document.getElementById('backBtn')?.addEventListener('click', () => {
                        play_audio('./audio/lemon.mp3', 0.6);
                    });
                }
                else {
                    if (state.current_step === 0) state.current_step = 1;

                    if (state.current_step === 1) {
                        imgEl.src = './image/ciallo.jpg';
                        captionEl.innerText = 'é›‘é­šæŸšå­å¨~ğŸ’—ğŸ’—ğŸ’—';
                        buttonPanel.innerHTML = `
                            <div class="button-row">
                                <button class="game-btn" id="step1_start">å¼€å§‹æ‘¸å¤´</button>
                            </div>
                        `;
                        document.getElementById('step1_start')?.addEventListener('click', () => {
                            play_audio('./audio/song.mp3', 0.1);
                            state.current_step = 2;
                            state.fail = 1;
                            render();
                        });
                    }
                    else if (state.current_step === 2) {
                        imgEl.src = './image/murasame1.jpg';
                        captionEl.innerText = 'æˆ‘å»ï¼Œæ‘¸å¤´èµ·æ‰‹ï¼Ÿä½ é«˜ä½æ˜¯ä¸ªä¸‰åƒï¼';
                        stop_audio('./audio/Murasame2.mp3');
                        stop_audio('./audio/Murasame3.mp3');
                        stop_audio('./audio/Murasame4.mp3');
                        play_audio('./audio/Murasame1.mp3');
                        buttonPanel.innerHTML = `
                            <div class="button-row">
                                <button class="game-btn" id="step2_continue">å˜¿å˜¿ï¼Œå¹¼åˆ€é…±~ç»§ç»­æ‘¸</button>
                                <button class="game-btn" id="step2_stop">æˆ‘å¥½åƒè¸©åˆ°åœ°é›·äº†ï¼Œå¯¸æ­¢ï¼</button>
                            </div>
                        `;
                        document.getElementById('step2_continue')?.addEventListener('click', () => {
                            state.affection = Math.min(state.affection + 8, 100);
                            state.current_step = 3;
                            render();
                        });
                        document.getElementById('step2_stop')?.addEventListener('click', () => {
                            state.affection = Math.max(state.affection - 5, 0);
                            state.current_step = 2.2;
                            render();
                        });
                    }
                    else if (state.current_step === 2.2) {
                        imgEl.src = './image/murasame2.jpg';
                        captionEl.innerText = 'ç‹—ï¼ä¿®ï¼é‡‘ï¼ï¼ï¼';
                        stop_audio('./audio/Murasame1.mp3');
                        stop_audio('./audio/Murasame3.mp3');
                        stop_audio('./audio/Murasame4.mp3');
                        play_audio('./audio/Murasame2.mp3');
                        buttonPanel.innerHTML = `
                            <div class="button-row">
                                <button class="game-btn" id="step22_back">å“æˆ‘ä¸€è·³,é‡Šæ”¾æ—¶é—´å›æº¯å¿æœ¯ï¼</button>
                                <button class="game-btn" id="step22_mo">å¹¼åˆ€é…±æ˜¯ä¸ªçº¯å°å­ï¼Œé‚£åªèƒ½æ‘¸å¤´äº†ğŸ˜­ğŸ˜­ğŸ˜­</button>
                                <button class="game-btn" id="step22_refuse">åŒºåŒºå¤ªå¹³å…¬ä¸»ï¼Œæˆ‘é¿å¥¹é”‹èŠ’ï¼Ÿ</button>
                                <button class="game-btn" id="step22_interact">666è¿˜æœ‰äº’åŠ¨ç¯èŠ‚</button>
                            </div>
                        `;
                        document.getElementById('step22_back')?.addEventListener('click', () => {
                            state.affection = Math.max(state.affection - 10, 0);
                            state.current_step = 1;
                            render();
                        });
                        document.getElementById('step22_mo')?.addEventListener('click', () => {
                            state.affection = Math.min(state.affection + 5, 100);
                            state.current_step = 2.1;
                            render();
                        });
                        document.getElementById('step22_refuse')?.addEventListener('click', () => {
                            state.affection = Math.max(state.affection - 20, 0);
                            state.current_step = -1;
                            render();
                        });
                        document.getElementById('step22_interact')?.addEventListener('click', () => {
                            showBigCiallo();
                            state.current_step = 114514;
                            state.affection = 78;
                            render();
                        });
                    }
                    else if (state.current_step === 2.1 || state.current_step === 3) {
                        imgEl.src = './image/murasame3.jpg';
                        captionEl.innerText = 'ç‹—~ä¿®~é‡‘~ğŸ’—';
                        stop_audio('./audio/Murasame1.mp3');
                        stop_audio('./audio/Murasame2.mp3');
                        stop_audio('./audio/Murasame4.mp3');
                        play_audio('./audio/Murasame3.mp3');
                        buttonPanel.innerHTML = `
                            <div class="button-row">
                                <button class="game-btn" id="step21_infinite">æ— é™æ‘¸å¤´æ‘¸ä¸ªçˆ½ï¼</button>
                                <button class="game-btn" id="step21_stop">ä¸æ‘¸äº†,å¥¹æ€»ä¸èƒ½æ˜¯æ»‘åŠ¨å˜é˜»å™¨å§</button>
                            </div>
                        `;
                        document.getElementById('step21_infinite')?.addEventListener('click', () => {
                            state.affection = Math.min(state.affection + 10, 100);
                            state.current_step = 2.1;
                            render();
                        });
                        document.getElementById('step21_stop')?.addEventListener('click', () => {
                            state.affection = Math.max(state.affection - 10, 0);
                            state.current_step = 2.2;
                            render();
                        });
                    }
                    else {
                        state.current_step = 1;
                        render();
                        return;
                    }
                }

                const extraCialloBtn = document.createElement('div');
                extraCialloBtn.className = 'button-row';
                extraCialloBtn.style.marginTop = '20px';
                extraCialloBtn.innerHTML = '<button class="game-btn" id="cialloExtraBtn">Ciallo~ (âˆ ãƒ»Ï‰< )âŒ’â˜…</button>';
                buttonPanel.appendChild(extraCialloBtn);
                document.getElementById('cialloExtraBtn')?.addEventListener('click', () => {
                    const num = Math.floor(Math.random() * 6) + 1;
                    play_audio(`./audio/ciallo${num}.mp3`);
                });
            }

            // é‡ç½®æŒ‰é’®ç›‘å¬
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'resetGameBtn') {
                    resetGame();
                }
            });

            window.addEventListener('load', () => {
                render();
            });
        })();
    </script>
</body>
</html>
